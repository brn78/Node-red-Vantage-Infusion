[
    {
        "id": "7ec2bb068e43779e",
        "type": "subflow",
        "name": "Vantage Infusion",
        "info": "",
        "category": "Vantage Infusion",
        "in": [
            {
                "x": 50,
                "y": 390,
                "wires": [
                    {
                        "id": "542ed55015b87207"
                    },
                    {
                        "id": "d8c1af7e223aa597"
                    },
                    {
                        "id": "95e991518a9e62b1"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 920,
                "y": 190,
                "wires": [
                    {
                        "id": "3c77ec77cc54b57d",
                        "port": 0
                    },
                    {
                        "id": "2e67021b6c114fff",
                        "port": 0
                    },
                    {
                        "id": "49453984e91a06f2",
                        "port": 1
                    }
                ]
            },
            {
                "x": 920,
                "y": 340,
                "wires": [
                    {
                        "id": "bfdbf76173cac6be",
                        "port": 0
                    },
                    {
                        "id": "a8f50e70a72bb8ac",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [
            {
                "name": "load",
                "type": "str",
                "value": "0",
                "ui": {
                    "icon": "font-awesome/fa-lightbulb-o",
                    "label": {
                        "en-US": "Loads ID:"
                    },
                    "type": "input",
                    "opts": {
                        "types": [
                            "str"
                        ]
                    }
                }
            },
            {
                "name": "sensor",
                "type": "str",
                "value": "0",
                "ui": {
                    "icon": "font-awesome/fa-feed",
                    "label": {
                        "en-US": "Sensors ID :"
                    },
                    "type": "input",
                    "opts": {
                        "types": [
                            "str"
                        ]
                    }
                }
            },
            {
                "name": "variable",
                "type": "str",
                "value": "0",
                "ui": {
                    "icon": "font-awesome/fa-code",
                    "label": {
                        "en-US": "Variables ID:"
                    },
                    "type": "input",
                    "opts": {
                        "types": [
                            "str"
                        ]
                    }
                }
            },
            {
                "name": "blind",
                "type": "str",
                "value": "0",
                "ui": {
                    "icon": "font-awesome/fa-columns",
                    "label": {
                        "en-US": "Blinds ID:"
                    },
                    "type": "input",
                    "opts": {
                        "types": [
                            "str"
                        ]
                    }
                }
            },
            {
                "name": "task",
                "type": "str",
                "value": "0",
                "ui": {
                    "icon": "font-awesome/fa-cogs",
                    "label": {
                        "en-US": "Tasks ID:"
                    },
                    "type": "input",
                    "opts": {
                        "types": [
                            "str"
                        ]
                    }
                }
            },
            {
                "name": "buttons_string",
                "type": "str",
                "value": "0",
                "ui": {
                    "icon": "font-awesome/fa-hand-pointer-o",
                    "label": {
                        "en-US": "Buttons ID:"
                    },
                    "type": "input",
                    "opts": {
                        "types": [
                            "str"
                        ]
                    }
                }
            },
            {
                "name": "watchdog",
                "type": "bool",
                "value": "true",
                "ui": {
                    "icon": "font-awesome/fa-heartbeat",
                    "label": {
                        "en-US": "Check the connection with the controller"
                    },
                    "type": "checkbox"
                }
            },
            {
                "name": "debug",
                "type": "bool",
                "value": "false",
                "ui": {
                    "icon": "font-awesome/fa-bug",
                    "label": {
                        "en-US": "Debugging information"
                    },
                    "type": "checkbox"
                }
            }
        ],
        "meta": {
            "module": "node-vantage-infusion",
            "version": "2.5.0",
            "author": "b.leonardi78@gmail.com",
            "desc": "Integrazione Vantage Infusion",
            "keywords": "vantage, infusion, legrand",
            "license": "MIT"
        },
        "color": "#FF66FF",
        "inputLabels": [
            "MQTT e Telnet"
        ],
        "outputLabels": [
            "Telnet",
            "MQTT"
        ],
        "icon": "font-awesome/fa-exchange",
        "status": {
            "x": 890,
            "y": 440,
            "wires": [
                {
                    "id": "178a49be5f052a42",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "bfdbf76173cac6be",
        "type": "function",
        "z": "7ec2bb068e43779e",
        "name": "Vantage response",
        "func": "/**\n * Vantage Infusion\n * Bruno Leonardi\n * 14/04/2023\n */\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//messaggi topic non passano\nif (msg.topic) return null\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\nvar data = []\nvar response = null\nvar func = new String\nvar vid = 0\nvar debug_text = msg.payload\nvar vantage_version = flow.get(\"version\")\nconst SPACE = ' '\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\nconst MANUFACTURER = flow.get(\"manufacturer\")\nconst POWERED_BY = flow.get(\"powered_by\")\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\nconst TOPIC_BUTTON = \"/button/vantage/status\"\nconst TOPIC_LOAD = \"/load/vantage/status\"\nconst TOPIC_BLIND = \"/blind/vantage/status\"\nconst TOPIC_VARIABLE = \"/variable/vantage/status\"\nconst TOPIC_SENSOR = \"/sensor/vantage/status\"\nconst TOPIC_TASK = \"/task/vantage/status\"\nconst TOPIC_VERSION = \"version/vantage/status\"\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n/**\n * Vantage General Function\n * @param {string} state Stato aggiornato\n * @param {string} topic Topic da inviare\n * @param {boolean} retain Impostazione MQTT\n */\nfunction SendUpdate(state, topic, retain = false) {\n    msg.payload = {}\n    msg.payload.state = state\n    msg.payload.attributes = {}\n    msg.payload.attributes.manufacturer = MANUFACTURER\n    msg.payload.attributes.response = response\n    msg.payload.attributes.data = state\n    msg.payload.attributes.powered_by = POWERED_BY\n    msg.payload.attributes.vid = vid\n    msg.payload.attributes.function = func\n    msg.payload.attributes.controller_version = vantage_version\n    //conversione payload a JSON String\n    msg.payload = JSON.stringify(msg.payload)\n    //impostazioni MQTT\n    msg.qos = 0\n    msg.retain = retain\n    msg.topic = `${vid}${topic}`\n    //output\n    node.send(msg)\n    //debug\n    if (env.get(\"debug\")) { node.log(debug_text) }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n/**\n * Vantage Sensor Function\n * @param {string} state Stato aggiornato\n * @param {boolean} retain Impostazione MQTT\n */\nfunction SendSensorUpdate(state, retain = true) {\n    msg.payload = {}\n    msg.payload.state = state\n    msg.payload.attributes = {}\n    msg.payload.attributes.manufacturer = MANUFACTURER\n    msg.payload.attributes.response = response\n    msg.payload.attributes.data = state\n    msg.payload.attributes.powered_by = POWERED_BY\n    msg.payload.attributes.vid = vid\n    msg.payload.attributes.function = func\n    msg.payload.attributes.controller_version = vantage_version\n    //conversione payload a JSON String\n    msg.payload = JSON.stringify(msg.payload)\n    //impostazioni MQTT\n    msg.qos = 0\n    msg.retain = retain\n    msg.topic = `${vid}${TOPIC_SENSOR}`\n    //output\n    node.send(msg)\n    //debug\n    if (env.get(\"debug\")) { node.log(debug_text) }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n/**\n * Vantage Button Function\n * @param {string} state Stato del pulsante\n * @param {string} trigger Trigger di aggiornamento stato\n * @param {boolean} retain Impostazione MQTT\n */\nfunction SendButtonUpdate(state, trigger, retain = true) {\n    msg.payload = {}\n    msg.payload.state = state\n    msg.payload.trigger = trigger\n    msg.payload.attributes = {}\n    msg.payload.attributes.manufacturer = MANUFACTURER\n    msg.payload.attributes.response = response\n    msg.payload.attributes.data = state\n    msg.payload.attributes.powered_by = POWERED_BY\n    msg.payload.attributes.vid = vid\n    msg.payload.attributes.trigger = trigger\n    msg.payload.attributes.function = func\n    msg.payload.attributes.controller_version = vantage_version\n    //conversione payload a JSON String\n    msg.payload = JSON.stringify(msg.payload)\n    //impostazioni MQTT\n    msg.qos = 0\n    msg.retain = retain\n    msg.topic = `${vid}${TOPIC_BUTTON}`\n    //output\n    node.send(msg)\n    //debug\n    if (env.get(\"debug\")) { node.log(debug_text) }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n/**\n * Vantage Load Function\n * @param {string} state Stato del carico\n * @param {string} brightness Luminosità del carico\n * @param {string} fade Livello dell'effetto\n * @param {boolean} retain Impostazione MQTT\n */\nfunction SendLoadUpdate(state, brightness, fade, retain = false) {\n    msg.payload = {}\n    msg.payload.state = state\n    msg.payload.brightness = brightness\n    msg.payload.fade = fade\n    msg.payload.attributes = {}\n    msg.payload.attributes.manufacturer = MANUFACTURER\n    msg.payload.attributes.response = response\n    msg.payload.attributes.data = state + ' | ' + brightness + ' | ' + fade\n    msg.payload.attributes.powered_by = POWERED_BY\n    msg.payload.attributes.vid = vid\n    msg.payload.attributes.brightness = brightness\n    msg.payload.attributes.fade = fade\n    msg.payload.attributes.function = func\n    msg.payload.attributes.controller_version = vantage_version\n    //conversione payload a JSON String\n    msg.payload = JSON.stringify(msg.payload)\n    //impostazioni MQTT\n    msg.qos = 0\n    msg.retain = retain\n    msg.topic = `${vid}${TOPIC_LOAD}`\n    //output\n    node.send(msg)\n    //debug\n    if (env.get(\"debug\")) { node.log(debug_text) }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n/**\n * Vantage Task Function\n * @param {string} state Stato task\n * @param {boolean} retain Impostazione MQTT\n */\nfunction SendTaskUpdate(state, retain = false) {\n    msg.payload = {}\n    msg.payload.state = state\n    msg.payload.attributes = {}\n    msg.payload.attributes.manufacturer = MANUFACTURER\n    msg.payload.attributes.response = response\n    msg.payload.attributes.data = state\n    msg.payload.attributes.powered_by = POWERED_BY\n    msg.payload.attributes.vid = vid\n    msg.payload.attributes.function = func\n    msg.payload.attributes.controller_version = vantage_version\n    //conversione payload a JSON String\n    msg.payload = JSON.stringify(msg.payload)\n    //impostazioni MQTT\n    msg.qos = 0\n    msg.retain = retain\n    msg.topic = `${vid}${TOPIC_TASK}`\n    //output\n    node.send(msg)\n    //debug\n    if (env.get(\"debug\")) { node.log(debug_text) }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n/**\n * Vantage Blind Function\n * @param {string} state Stato della serranda\n * @param {string} position Posizione della serranda\n * @param {boolean} retain Impostazione MQTT\n */\nfunction SendBlindUpdate(state, position, retain = false) {\n    msg.payload = {}\n    msg.payload.state = state\n    msg.payload.position = position\n    msg.payload.attributes = {}\n    msg.payload.attributes.manufacturer = MANUFACTURER\n    msg.payload.attributes.response = response\n    msg.payload.attributes.data = state + ' | ' + position\n    msg.payload.attributes.powered_by = POWERED_BY\n    msg.payload.attributes.vid = vid\n    msg.payload.attributes.state = state\n    msg.payload.attributes.position = position\n    msg.payload.attributes.function = func\n    msg.payload.attributes.controller_version = vantage_version\n    //conversione payload a JSON String\n    msg.payload = JSON.stringify(msg.payload)\n    //impostazioni MQTT\n    msg.qos = 0\n    msg.retain = retain\n    msg.topic = `${vid}${TOPIC_BLIND}`\n    //output\n    node.send(msg)\n    //debug\n    if (env.get(\"debug\")) { node.log(debug_text) }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n/**\n * Vantage General Function\n * @param {object} state Stato aggiornato\n * @param {boolean} retain Impostazione MQTT\n */\nfunction SendVariableUpdate(state, retain = false) {\n    msg.payload = {}\n    msg.payload.state = state[0]\n    msg.payload.binary = state[1]\n    msg.payload.attributes = {}\n    msg.payload.attributes.manufacturer = MANUFACTURER\n    msg.payload.attributes.response = response\n    msg.payload.attributes.data = state[0] + \" | \" + state[1]\n    msg.payload.attributes.powered_by = POWERED_BY\n    msg.payload.attributes.vid = vid\n    msg.payload.attributes.function = func\n    msg.payload.attributes.controller_version = vantage_version\n    //conversione payload a JSON String\n    msg.payload = JSON.stringify(msg.payload)\n    //impostazioni MQTT\n    msg.qos = 0\n    msg.retain = retain\n    msg.topic = `${vid}${TOPIC_VARIABLE}`\n    //output\n    node.send(msg)\n    //debug\n    if (env.get(\"debug\")) { node.log(debug_text) }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//status node\nif (msg.payload == \"reset\") {\n    node.status({ fill: \"blue\", shape: \"ring\", text: \"Waiting data\" })\n    return null\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//il primo match + insensitive case\nString.prototype.IsThis = function (/** @type {string | RegExp} */ x) {\n    let re = new RegExp(x, 'i')\n    return (this.search(re) === -1) ? false : true\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//response\nif (msg.payload) {\n    response = msg.payload\n    data = (msg.payload.substr(2)).split(\" \")\n    func = data[0]\n    vid = parseInt(data[1])\n\n    if (func.IsThis('BTN')) {\n        //data extraction\n        const TRIGGER = data[2]\n        const STATE = (data[2] == \"RELEASE\") ? \"OFF\" : \"ON\"\n        //output\n        func = \"Button Function\"\n        debug_text = `Button ${vid} has changed to ${STATE} with trigger ${TRIGGER}`\n        node.status({ fill: \"green\", shape: \"dot\", text: debug_text })\n        SendButtonUpdate(STATE, TRIGGER)\n    } else if (func.IsThis('LOAD')) {\n        //data extraction\n        const STATE = (parseInt(data[2]) == 0) ? \"OFF\" : \"ON\"\n        const BRIGHTNESS = Math.round(parseInt(data[2]) * 2.55)\n        const FADE = (data[3] === undefined || data[3] === null) ? 0 : parseInt(data[3])\n        //output\n        func = \"Load Function\"\n        debug_text = `Load ${vid} has changed to ${STATE} with brightness ${parseInt(data[2])}%`\n        node.status({ fill: \"green\", shape: \"dot\", text: debug_text })\n        SendLoadUpdate(STATE, BRIGHTNESS, FADE)\n    } else if (func.IsThis('TASK')) {\n        //data extraction\n        const STATE = (parseInt(data[2]) == 0) ? \"OFF\" : \"ON\"\n        //output\n        func = \"Task Function\"\n        debug_text = `Task ${vid} has changed to ${STATE}`\n        node.status({ fill: \"green\", shape: \"dot\", text: debug_text })\n        SendTaskUpdate(STATE)\n    } else if (func.IsThis('BLIND')) {\n        //data extraction\n        const STATE = (data[2] && parseInt(data[2]) == 0) ? \"closed\" : \"open\"\n        const POSITION = data[2] ? Math.round(parseInt(data[2])) : 0\n        //output\n        func = \"Blind Function\"\n        debug_text = `Blind ${vid} has changed to ${STATE} with position ${POSITION}%`\n        node.status({ fill: \"green\", shape: \"dot\", text: debug_text })\n        SendBlindUpdate(STATE, POSITION)\n    } else if (func.IsThis('VARIABLE')) {\n        //data extraction\n        let value = []\n        data = msg.payload.substr(2)\n        data = data.replace(`${func}${SPACE}${vid}${SPACE}`, \"\")\n\n        //rimuovo \"\"\n        if (data.startsWith('\"') && data.endsWith('\"')) {\n            data = data.substring(data.indexOf('\"') + 1, data.lastIndexOf('\"')).trim()\n        }\n\n        //state\n        value.push(data)\n\n        //binary\n        if (!isNaN(data)) {\n            value.push((parseInt(data) <= 0) ? \"OFF\" : \"ON\")\n        } else if (data.toLowerCase() == 'on' || data.toLowerCase() == 'off') {\n            value.push(data.toUpperCase())\n        } else {\n            value.push(data)\n        }\n\n        //output\n        func = \"Variable Function\"\n        debug_text = `Variable ${vid} has changed to ${value[0]} | ${value[1]}`\n        node.status({ fill: \"green\", shape: \"dot\", text: debug_text })\n        SendVariableUpdate(value)\n    } else if (func.IsThis('SENSOR')) {\n        //data extraction\n        const STATE = data[2]\n        //output\n        func = \"Sensor Function\"\n        debug_text = `Sensor ${vid} has changed to ${STATE}`\n        node.status({ fill: \"green\", shape: \"dot\", text: debug_text })\n        SendSensorUpdate(STATE)\n    } else if (func.IsThis('VERSION')) {\n        //data extraction\n        const STATE = data[1]\n        vantage_version = STATE\n        flow.set(\"version\", vantage_version)\n        vid = \"\"\n        //output\n        func = \"Controller Version\"\n        debug_text = `Controller Version ${STATE}`\n        node.status({ fill: \"green\", shape: \"dot\", text: debug_text })\n        SendUpdate(STATE, TOPIC_VERSION)\n    } else {\n        node.status({ fill: \"red\", shape: \"dot\", text: debug_text })\n    }\n}\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\nflow.set(\"manufacturer\", \"Vantage Controls © 2016\")\nflow.set(\"powered_by\", \"Bruno Leonardi © 2023\")\nflow.set(\"version\", \"unknown\")\n\nnode.status({ fill: \"blue\", shape: \"ring\", text: \"Initialized\" })",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "c6a422c3484f5c06",
        "type": "status",
        "z": "7ec2bb068e43779e",
        "name": "",
        "scope": [
            "bfdbf76173cac6be",
            "4552fd57150d1dbe",
            "c936c0dfeb10bce6"
        ],
        "x": 610,
        "y": 440,
        "wires": [
            [
                "178a49be5f052a42"
            ]
        ]
    },
    {
        "id": "d8c1af7e223aa597",
        "type": "trigger",
        "z": "7ec2bb068e43779e",
        "name": "Reset status node",
        "op1": "",
        "op2": "reset",
        "op1type": "nul",
        "op2type": "str",
        "duration": "10",
        "extend": true,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 320,
        "y": 340,
        "wires": [
            [
                "bfdbf76173cac6be"
            ]
        ]
    },
    {
        "id": "95e991518a9e62b1",
        "type": "trigger",
        "z": "7ec2bb068e43779e",
        "name": "Timeout connection",
        "op1": "",
        "op2": "timeout_off",
        "op1type": "nul",
        "op2type": "str",
        "duration": "5",
        "extend": true,
        "overrideDelay": false,
        "units": "min",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 320,
        "y": 390,
        "wires": [
            [
                "4552fd57150d1dbe"
            ]
        ]
    },
    {
        "id": "4552fd57150d1dbe",
        "type": "function",
        "z": "7ec2bb068e43779e",
        "name": "Connection status",
        "func": "/**\n * Vantage Infusion\n * Bruno Leonardi\n * 28/07/2022\n */\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//messaggi topic non passano\nif (msg.topic) return null\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\n//output\nconst STATE = (msg.payload == \"timeout_off\") ? \"OFF\" : \"ON\"\n\nif (STATE == \"OFF\") {\n    node.status({fill:\"red\", shape:\"dot\", text:\"Disconnected\"})\n}\n\nmsg.payload = {}\nmsg.payload.state = STATE\nmsg.payload.attributes = {}\nmsg.payload.attributes.manufacturer = flow.get(\"manufacturer\")\nmsg.payload.attributes.powered_by = flow.get(\"powered_by\")\nmsg.payload.attributes.function = \"Connection status\"\nmsg.payload.attributes.controller_version = flow.get(\"version\")\n//conversione payload a JSON String\nmsg.payload = JSON.stringify(msg.payload)\n//impostazioni MQTT\nmsg.qos = 0\nmsg.retain = true\nmsg.topic = \"connection/vantage/status\"\n//output\nnode.send(msg)",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 390,
        "wires": [
            [
                "a8f50e70a72bb8ac"
            ]
        ]
    },
    {
        "id": "a8f50e70a72bb8ac",
        "type": "delay",
        "z": "7ec2bb068e43779e",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 785,
        "y": 390,
        "wires": [
            []
        ],
        "l": false
    },
    {
        "id": "dc3c8dc4682041f0",
        "type": "inject",
        "z": "7ec2bb068e43779e",
        "name": "Watchdog 1m",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "60",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "VERSION",
        "payloadType": "str",
        "x": 330,
        "y": 140,
        "wires": [
            [
                "2e67021b6c114fff"
            ]
        ]
    },
    {
        "id": "2e67021b6c114fff",
        "type": "function",
        "z": "7ec2bb068e43779e",
        "name": "Sync request",
        "func": "/**\n * Vantage Infusion\n * Bruno Leonardi\n * 14/04/2023\n */\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//testo per il debug\nvar debug_text = ''\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n/**\n * Invia un richiesta a Vantage\n * @param {string} command Comando da inviare\n */\nfunction SendRequest(command) {\n    node.send({ payload: command })\n    if (env.get(\"debug\")) { node.log(debug_text) }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//controllo connessione\nif (msg.payload == 'VERSION') {\n    if (env.get(\"watchdog\")) {\n        debug_text = `Watchdog connection send a version request`\n        SendRequest(\"VERSION\")\n    }\n    return null\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////\n\nconst TYPE = msg.payload\nvar array = []\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\nif (env.get(\"debug\")) { node.log('Start synchronization') }\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//load sync\nif (TYPE == 'SYNC' || TYPE == 'SYNC_LOAD') {\n    array = (env.get(\"load\")).split(\",\")\n    for (let i = 0; i < array.length; i++) {\n        if (parseInt(array[i]) > 0) {\n            debug_text = `Load vid ${array[i]} send request`\n            SendRequest(`GETLOAD ${array[i]}`)\n        }\n    }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//blind sync\nif (TYPE == 'SYNC' || TYPE == 'SYNC_BLIND') {\n    array = (env.get(\"blind\")).split(\",\")\n    for (let i = 0; i < array.length; i++) {\n        if (parseInt(array[i]) > 0) {\n            debug_text = `Load vid ${array[i]} send request`\n            SendRequest(`GETBLIND ${array[i]}`)\n        }\n    }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//sensor sync\nif (TYPE == 'SYNC' || TYPE == 'SYNC_SENSOR') {\n    array = (env.get(\"sensor\")).split(\",\")\n    for (let i = 0; i < array.length; i++) {\n        if (parseInt(array[i]) > 0) {\n            debug_text = `Sensor vid ${array[i]} send request`\n            SendRequest(`GETSENSOR ${array[i]}`)\n        }\n    }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//variable sync\nif (TYPE == 'SYNC' || TYPE == 'SYNC_VARIABLE') {\n    array = (env.get(\"variable\")).split(\",\")\n    for (let i = 0; i < array.length; i++) {\n        if (parseInt(array[i]) > 0) {\n            debug_text = `Variable vid ${array[i]} send request`\n            SendRequest(`GETVARIABLE ${array[i]}`)\n        }\n    }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//task sync\nif (TYPE == 'SYNC' || TYPE == 'SYNC_TASK') {\n    array = (env.get(\"task\")).split(\",\")\n    for (let i = 0; i < array.length; i++) {\n        if (parseInt(array[i]) > 0) {\n            debug_text = `Task vid ${array[i]} send request`\n            SendRequest(`GETTASK ${array[i]}`)\n        }\n    }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 190,
        "wires": [
            []
        ]
    },
    {
        "id": "3c77ec77cc54b57d",
        "type": "inject",
        "z": "7ec2bb068e43779e",
        "name": "STATUS ALL",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": true,
        "onceDelay": "5",
        "topic": "",
        "payload": "STATUS ALL",
        "payloadType": "str",
        "x": 590,
        "y": 90,
        "wires": [
            []
        ]
    },
    {
        "id": "7da07ba87b185bbc",
        "type": "function",
        "z": "7ec2bb068e43779e",
        "name": "Button reset",
        "func": "/**\n * Vantage Infusion\n * Bruno Leonardi\n * 14/04/2023\n */\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//numero di vid buttons\nvar buttons_string = env.get(\"buttons_string\").trim()\n//array di buttons_string\nvar buttons = buttons_string.split(\",\")\n//testo di debug\nvar debug_text = null\n\n//sincronizza i buttons\nif (buttons.length > 0) {\n    for (let i = 0; i < buttons.length; i++) {\n        const button = parseInt(buttons[i])\n        if (button > 0) {\n            node.send({ payload: `X:BTN ${button} RELEASE` })\n            debug_text = `Button vid ${button} reset state`\n            if (env.get(\"debug\")) { node.log(debug_text) }\n        }\n    }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 290,
        "wires": [
            [
                "bfdbf76173cac6be"
            ]
        ]
    },
    {
        "id": "288c0eaa537d3e18",
        "type": "inject",
        "z": "7ec2bb068e43779e",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "5",
        "topic": "",
        "x": 215,
        "y": 290,
        "wires": [
            [
                "7da07ba87b185bbc"
            ]
        ],
        "l": false
    },
    {
        "id": "943d271275c8dac9",
        "type": "comment",
        "z": "7ec2bb068e43779e",
        "name": "Aggiornato il 20/02/2023",
        "info": "",
        "x": 300,
        "y": 440,
        "wires": []
    },
    {
        "id": "178a49be5f052a42",
        "type": "delay",
        "z": "7ec2bb068e43779e",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "6",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 785,
        "y": 440,
        "wires": [
            [
                "777813c3ce2ab8de"
            ]
        ],
        "l": false
    },
    {
        "id": "542ed55015b87207",
        "type": "function",
        "z": "7ec2bb068e43779e",
        "name": "Switch request and response",
        "func": "/**\n * Vantage Infusion\n * Bruno Leonardi\n * 28/07/2022\n */\n\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\nif (msg.topic) {\n    //filtra gli stati\n    if (msg.topic.search(/status/gi) !== -1) return null\n    //passano solo i topic di vantage\n    if (msg.topic.search(/vantage/gi) === -1) return null\n    //request\n    return [msg, null]\n} else {\n    //respone\n    return [null, msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 240,
        "wires": [
            [
                "49453984e91a06f2",
                "2321cc09391dc58c"
            ],
            [
                "bfdbf76173cac6be",
                "4552fd57150d1dbe"
            ]
        ],
        "inputLabels": [
            "Input"
        ],
        "outputLabels": [
            "Request",
            "Response"
        ]
    },
    {
        "id": "49453984e91a06f2",
        "type": "function",
        "z": "7ec2bb068e43779e",
        "name": "Vantage request",
        "func": "/**\n * Vantage Infusion\n * Bruno Leonardi\n * 14/04/2023\n */\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////\n\n//messaggi obbligatori\nif (!msg.topic) return null\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\nconst ALL_SYNC = msg.topic.endsWith(\"all/vantage/sync\")\nconst LOAD_SYNC = msg.topic.endsWith(\"/load/vantage/sync\")\nconst BLIND_SYNC = msg.topic.endsWith(\"/blind/vantage/sync\")\nconst SENSOR_SYNC = msg.topic.endsWith(\"/sensor/vantage/sync\")\nconst VARIABLE_SYNC = msg.topic.endsWith(\"/variable/vantage/sync\")\nconst TASK_SYNC = msg.topic.endsWith(\"/task/vantage/sync\")\nconst LOAD = msg.topic.endsWith(\"/load/vantage/set\")\nconst BLIND = msg.topic.endsWith(\"/blind/vantage/set\")\nconst TASK = msg.topic.endsWith(\"/task/vantage/set\")\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\nvar Payload = ''\nvar Topic = ''\nvar vid = null\nvar trigger = \"BOOT\"\nvar Output = null\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n//FUNCTIONS\n\nfunction SetLoadSync() {\n    Topic = Topic.split(\"/\")\n    vid = Topic[0]\n    return `GETLOAD ${vid}`\n}\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\nfunction SetBlindSync() {\n    Topic = Topic.split(\"/\")\n    vid = Topic[0]\n    return `GETBLIND ${vid}`\n}\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\nfunction SetSensorSync() {\n    Topic = Topic.split(\"/\")\n    vid = Topic[0]\n    return `GETSENSOR ${vid}`\n}\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\nfunction SetVariableSync() {\n    Topic = Topic.split(\"/\")\n    vid = Topic[0]\n    return `GETVARIABLE ${vid}`\n}\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\nfunction SetTaskSync() {\n    Topic = Topic.split(\"/\")\n    vid = Topic[0]\n    return `GETTASK ${vid}`\n}\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\nfunction SetLoad() {\n    Topic = Topic.split(\"/\")\n    vid = Topic[0]\n\n    if (Payload == \"ON\") {\n        Payload = `LOAD ${vid} 100`\n    } else if (Payload == \"OFF\") {\n        Payload = `LOAD ${vid} 0`\n    } else if (parseInt(Payload) >= 0 && parseInt(Payload) <= 255) {\n        Payload = `LOAD ${vid} ${Math.round(parseInt(Payload) / 2.55)}`\n    } else {\n        Payload = null\n    }\n\n    return Payload\n}\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\nfunction SetBlind() {\n    Topic = Topic.split(\"/\")\n    vid = Topic[0]\n\n    if (Payload == \"OPEN\") {\n        Payload = `BLIND ${vid} ${Payload}`\n    } else if (Payload == \"STOP\") {\n        Payload = `BLIND ${vid} ${Payload}`\n    } else if (Payload == \"CLOSE\") {\n        Payload = `BLIND ${vid} ${Payload}`\n    } else if (parseInt(Payload) >= 0 && parseInt(Payload) <= 100) {\n        Payload = `BLIND ${vid} POS ${Payload}`\n    } else {\n        Payload = null\n    }\n\n    return Payload\n}\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n\nfunction SetTask() {\n    Topic = Topic.split(\"/\")\n    vid = Topic[0]\n\n    if (Payload.search(/[on-off]/gi) !== -1) {\n        trigger = \"BOOT\"\n    } else if (parseInt(Payload) >= 0 && parseInt(Payload) <= 255) {\n        trigger = \"BOOT\"\n    } else if (Topic[1] == \"task\") {\n        trigger = \"BOOT\"\n    } else {\n        trigger = Topic[1]\n    }\n\n    return `TASK ${vid} ${trigger}`\n}\n\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////\n//OUTPUT\n\nPayload = msg.payload\nTopic = msg.topic\n\nif (LOAD_SYNC) {\n    Output = SetLoadSync()\n} else if (BLIND_SYNC) {\n    Output = SetBlindSync()\n} else if (SENSOR_SYNC) {\n    Output = SetSensorSync()\n} else if (VARIABLE_SYNC) {\n    Output = SetVariableSync()\n} else if (TASK_SYNC) {\n    Output = SetTaskSync()\n} else if (LOAD) {\n    Output = SetLoad()\n} else if (BLIND) {\n    Output = SetBlind()\n} else if (TASK) {\n    Output = SetTask()\n} else if (ALL_SYNC) {\n    if (env.get(\"debug\")) { node.log('SYNC ALL') }\n    return [{ payload: 'SYNC' }, null]\n} else {\n    return null\n}\n\nif (!Output) {\n    if (env.get(\"debug\")) { node.log('Payload not match | ' + Payload) }\n    return null\n}\n\n//debug log\nif (env.get(\"debug\")) { node.log(Output) }\n\n//invia il messaggio\nreturn [null, { payload: Output }]",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 240,
        "wires": [
            [
                "2e67021b6c114fff"
            ],
            []
        ],
        "inputLabels": [
            "OWN Event Session"
        ],
        "outputLabels": [
            "Output",
            ""
        ],
        "icon": "font-awesome/fa-gears"
    },
    {
        "id": "c4eac60edd69d493",
        "type": "catch",
        "z": "7ec2bb068e43779e",
        "name": "",
        "scope": [
            "d9ac8c90f14df475",
            "2e67021b6c114fff",
            "49453984e91a06f2",
            "542ed55015b87207",
            "7da07ba87b185bbc",
            "bfdbf76173cac6be",
            "4552fd57150d1dbe"
        ],
        "uncaught": false,
        "x": 620,
        "y": 290,
        "wires": [
            [
                "2aeb36ca1976243a"
            ]
        ]
    },
    {
        "id": "2aeb36ca1976243a",
        "type": "function",
        "z": "7ec2bb068e43779e",
        "name": "Node error",
        "func": "node.error(msg.error, msg)",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 290,
        "wires": []
    },
    {
        "id": "2321cc09391dc58c",
        "type": "trigger",
        "z": "7ec2bb068e43779e",
        "name": "Sync at 5m",
        "op1": "",
        "op2": "SYNC",
        "op1type": "nul",
        "op2type": "str",
        "duration": "5",
        "extend": true,
        "overrideDelay": false,
        "units": "min",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 340,
        "y": 190,
        "wires": [
            [
                "2e67021b6c114fff"
            ]
        ]
    },
    {
        "id": "eb0722e1a7b126fc",
        "type": "inject",
        "z": "7ec2bb068e43779e",
        "name": "Sync on startup",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "15",
        "topic": "",
        "payload": "SYNC",
        "payloadType": "str",
        "x": 330,
        "y": 90,
        "wires": [
            [
                "2e67021b6c114fff"
            ]
        ]
    },
    {
        "id": "ad906b80090b8850",
        "type": "inject",
        "z": "7ec2bb068e43779e",
        "name": "Sync sensor",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "60",
        "crontab": "",
        "once": false,
        "onceDelay": "10",
        "topic": "",
        "payload": "SYNC_SENSOR",
        "payloadType": "str",
        "x": 590,
        "y": 140,
        "wires": [
            [
                "2e67021b6c114fff"
            ]
        ]
    },
    {
        "id": "c936c0dfeb10bce6",
        "type": "function",
        "z": "7ec2bb068e43779e",
        "name": "Reset status node",
        "func": "node.status({ fill: \"blue\", shape: \"ring\", text: \"Waiting data\" })\nreturn null",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 500,
        "wires": []
    },
    {
        "id": "777813c3ce2ab8de",
        "type": "trigger",
        "z": "7ec2bb068e43779e",
        "name": "",
        "op1": "",
        "op2": "0",
        "op1type": "nul",
        "op2type": "str",
        "duration": "10",
        "extend": true,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 785,
        "y": 500,
        "wires": [
            [
                "c936c0dfeb10bce6"
            ]
        ],
        "l": false
    },
    {
        "id": "7e037080d9149b83",
        "type": "subflow:7ec2bb068e43779e",
        "z": "99d9e9de.7f00a8",
        "name": "",
        "x": 460,
        "y": 390,
        "wires": [
            [],
            []
        ]
    }
]
